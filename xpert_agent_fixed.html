<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xpert v3 - Step 5: 에이전트 분석</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #f8f9fa;
            color: #2c2c2c;
            line-height: 1.6;
            overflow-x: hidden;
            height: 100vh;
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 헤더 */
        .header {
            background: white;
            border-bottom: 2px solid #e9ecef;
            padding: 20px 32px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .progress-flow {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .step-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .step-indicator.completed {
            background: #34c759;
            color: white;
        }

        .step-indicator.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: scale(1.05);
        }

        .step-indicator.pending {
            background: #f1f3f4;
            color: #6e6e73;
        }

        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }

        .step-indicator.pending .step-number {
            background: #d1d1d6;
            color: white;
        }

        /* 메인 컨텐츠 */
        .main-content {
            flex: 1;
            margin-top: 80px;
            min-height: calc(100vh - 80px);
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 1fr auto;
        }

        /* 좌측: Step 4 팀 맥락 */
        .team-context {
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }

        /* 초기 강한 펄스 효과 */
        @keyframes strong-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
                border-color: #667eea;
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 12px rgba(102, 126, 234, 0.4), 0 0 40px rgba(102, 126, 234, 0.3);
                border-color: #3b82f6;
                transform: scale(1.01);
            }
        }

        .team-context.initial-pulse {
            border: 3px solid #667eea;
            animation: strong-pulse 2s infinite;
        }

        .context-header {
            font-size: 16px;
            font-weight: 700;
            color: #2c2c2c;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dataset-section {
            margin-bottom: 24px;
        }

        .dataset-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .team-dataset {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .team-dataset:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .team-dataset.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .team-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dataset-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .dataset-fields {
            font-size: 11px;
            color: #888;
            background: #f8f9fa;
            padding: 6px 8px;
            border-radius: 4px;
        }

        /* 중앙: 통합 분석 영역 */
        .analysis-main {
            background: white;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .analysis-header {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e9ecef;
        }

        .selected-team {
            font-size: 20px;
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 8px;
        }

        .analysis-request {
            font-size: 14px;
            color: #666;
            background: rgba(102, 126, 234, 0.05);
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        /* 분석 선택 섹션 */
        .analysis-section {
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .analysis-section.hidden {
            display: none;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .analysis-option {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .analysis-option:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .analysis-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 8px;
        }

        .option-desc {
            font-size: 14px;
            color: #666;
        }

        /* 자동 데이터 검토 섹션 */
        .auto-review-section {
            margin-bottom: 24px;
        }

        .review-header {
            margin-bottom: 20px;
        }

        .review-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .review-progress {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 14px;
            color: #666;
            text-align: center;
        }

        .review-insights {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .insight-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
        }

        .insight-item.show {
            opacity: 1;
            transform: translateY(0);
        }

        .insight-icon {
            font-size: 18px;
        }

        /* 추천 모듈 섹션 */
        .recommended-modules {
            margin-bottom: 24px;
        }

        .modules-header {
            font-size: 16px;
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .module-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
        }

        .module-card.show {
            opacity: 1;
            transform: translateY(0);
        }

        .module-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .module-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .module-icon {
            font-size: 24px;
            margin-bottom: 12px;
        }

        .module-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 8px;
        }

        .module-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .module-meta {
            font-size: 12px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .confidence-badge {
            background: #e7f5e7;
            color: #2d5a2d;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .custom-request {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-top: 12px;
        }

        .custom-request-text {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .custom-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .custom-submit {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-submit:hover {
            background: #5a6fd8;
        }

        /* 실행 섹션 */
        .execute-section {
            text-align: center;
        }

        .execute-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .execute-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .execute-button:disabled {
            background: #dee2e6;
            color: #adb5bd;
            cursor: not-allowed;
            box-shadow: none;
        }

        .execute-button-old {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            width: 100%;
        }

        .execute-button-old:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .execute-button-old:disabled {
            background: #dee2e6;
            color: #adb5bd;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* 분석 진행 */
        .analysis-progress {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }

        .progress-header {
            margin-bottom: 32px;
        }

        .progress-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .progress-title {
            font-size: 20px;
            font-weight: 600;
            color: #667eea;
        }

        .progress-content {
            font-size: 16px;
            color: #495057;
            font-weight: 500;
        }

        /* 결과 섹션 */
        .results-section {
            flex: 1;
            display: none;
        }

        .results-grid {
            display: grid;
            gap: 20px;
        }

        .result-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .result-content {
            font-size: 14px;
            color: #495057;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .result-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-tag {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tag-report {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .tag-report.selected {
            background: #1976d2;
            color: white;
            transform: scale(1.05);
        }

        .tag-collaborate {
            background: #fff3e0;
            color: #f57c00;
            border: 1px solid #ffcc02;
        }

        .tag-collaborate.selected {
            background: #f57c00;
            color: white;
            transform: scale(1.05);
        }

        .add-team-btn {
            background: #f8f9fa;
            color: #667eea;
            border: 1px dashed #667eea;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .add-team-btn:hover {
            background: #f0f4ff;
            border-style: solid;
        }

        .team-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 9999;
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .team-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .dropdown-item:hover {
            background: #f0f4ff;
            color: #667eea;
        }

        /* 협업 코멘트 섹션 */
        .collab-comment-section {
            margin-top: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            display: none;
        }

        .collab-comment-section.show {
            display: block;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .collab-comment-label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .collab-comment-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            background: white;
        }

        .collab-comment-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .collab-comment-textarea::placeholder {
            color: #8e8e93;
        }

        /* 빈 상태 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8e8e93;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* 우측: SPAR + 협업 도구 */
        .right-panel {
            background: #f8f9fa;
            border-left: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .spar-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            position: relative;
            border: 2px solid #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.03) 100%);
        }

        /* 초기 강한 펄스 효과 */
        .spar-section.initial-pulse {
            animation: strong-pulse 2s infinite;
        }

        .spar-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .spar-steps {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .spar-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        .spar-step.completed {
            background: #e7f5e7;
        }

        .spar-step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid #4f46e5;
            position: relative;
            animation: spar-pulse 1.5s infinite;
        }

        .spar-step.active .spar-label {
            color: white;
            font-weight: 700;
        }

        .spar-step.active .spar-desc {
            color: rgba(255, 255, 255, 0.9);
        }

        /* 진행 중인 스텝을 위한 강한 펄스 효과 */
        @keyframes progress-pulse {
            0%, 100% {
                background: #ff9500;
                box-shadow: 0 0 0 0 rgba(255, 149, 0, 0.6);
                transform: scale(1);
                border-color: #ff6b35;
            }
            50% {
                background: #ff6b35;
                box-shadow: 0 0 0 8px rgba(255, 149, 0, 0.4), 0 0 25px rgba(255, 149, 0, 0.3);
                transform: scale(1.02);
                border-color: #e5580b;
            }
        }

        .spar-step.progress {
            background: #ff9500;
            color: white;
            border: 2px solid #ff6b35;
            position: relative;
            animation: progress-pulse 1.2s infinite;
        }

        .spar-step.progress .spar-label {
            color: white;
            font-weight: 700;
        }

        .spar-step.progress .spar-desc {
            color: rgba(255, 255, 255, 0.9);
        }

        @keyframes spar-pulse {
            0%, 100% {
                border-color: #4f46e5;
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.3);
                transform: scale(1);
            }
            50% {
                border-color: #3b82f6;
                box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.4), 0 0 20px rgba(102, 126, 234, 0.2);
                transform: scale(1.02);
            }
        }

        .spar-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: white;
        }

        .sense { background: #ff6b6b; }
        .plan { background: #4ecdc4; }
        .act { background: #45b7d1; }
        .reflect { background: #96ceb4; }

        .spar-content {
            flex: 1;
        }

        .spar-label {
            font-size: 14px;
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 4px;
        }

        .spar-desc {
            font-size: 12px;
            color: #666;
        }

        /* Sense 단계 말풍선 - 가장 앞으로 */
        .sense-tooltip {
            position: absolute;
            top: 50%;
            left: -250px;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
            max-width: 220px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
            animation: tooltip-pulse 2s infinite;
        }

        @keyframes tooltip-pulse {
            0%, 100% {
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6), 0 0 20px rgba(102, 126, 234, 0.3);
            }
        }

        .sense-tooltip.show {
            opacity: 1;
            visibility: visible;
        }

        .sense-tooltip::before {
            content: "";
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 12px 0 12px 12px;
            border-color: transparent transparent transparent #667eea;
        }

        /* 협업 섹션 */
        .collaboration-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            flex: 1;
        }

        .collab-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c2c2c;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collaboration-cart {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
        }

        .cart-header {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 12px;
        }

        .cart-items {
            flex: 1;
            margin-bottom: 12px;
        }

        .cart-empty {
            text-align: center;
            color: #8e8e93;
            font-size: 14px;
            padding: 20px;
        }

        .cart-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-item-text {
            flex: 1;
        }

        .cart-remove {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            margin-left: 8px;
        }

        .cart-remove:hover {
            background: #e55555;
        }

        .send-collaboration-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-collaboration-btn:hover:not(:disabled) {
            background: #1e7e34;
        }

        .send-collaboration-btn:disabled {
            background: #dee2e6;
            color: #adb5bd;
            cursor: not-allowed;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            margin-top: 12px;
            display: none;
        }

        .collaboration-summary {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e9ecef;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .summary-label {
            font-size: 12px;
            color: #666;
        }

        .summary-count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .summary-count.orange {
            background: #ff9500;
        }

        /* 하단 네비게이션 */
        .bottom-controls {
            grid-column: 1 / -1;
            background: white;
            border-top: 1px solid #e9ecef;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-button {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .nav-button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .nav-button.primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .nav-button:disabled {
            background: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
        }

        /* 반응형 */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
            
            .team-context, .right-panel {
                display: none;
            }

            .analysis-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="logo">Xpert</div>
                
                <div class="progress-flow">
                    <div class="step-indicator completed" id="step1-indicator">
                        <div class="step-number">1</div>
                        <span>데이터 연결</span>
                    </div>
                    <div class="step-indicator completed" id="step2-indicator">
                        <div class="step-number">2</div>
                        <span>보안 처리</span>
                    </div>
                    <div class="step-indicator completed" id="step3-indicator">
                        <div class="step-number">3</div>
                        <span>협업 워크스페이스</span>
                    </div>
                    <div class="step-indicator active" id="step4-indicator">
                        <div class="step-number">4</div>
                        <span>에이전트 분석</span>
                    </div>
                    <div class="step-indicator pending" id="step5-indicator">
                        <div class="step-number">5</div>
                        <span>통합 리포트</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- 메인 컨텐츠 -->
        <div class="main-content">
            <!-- 좌측: Step 4 팀 맥락 -->
            <div class="team-context" id="teamContext">
                <div class="context-header">
                    📊 보유 데이터셋
                </div>
                
                <div class="dataset-section">
                    <div class="dataset-section-title">👤 소속팀 데이터셋</div>
                    <div class="team-dataset" onclick="selectTeam('marketing')">
                        <div class="team-name">📊 마케팅팀</div>
                        <div class="dataset-info">고객 세그먼트 분석 데이터</div>
                        <div class="dataset-fields">고객ID, 연령대, 구매이력, 이탈율</div>
                    </div>
                </div>

                <div class="dataset-section">
                    <div class="dataset-section-title">🔄 공유받은 데이터셋</div>
                    <div class="team-dataset" onclick="selectTeam('finance')">
                        <div class="team-name">💰 재무팀</div>
                        <div class="dataset-info">마케팅 ROI 분석 데이터</div>
                        <div class="dataset-fields">캠페인ID, 비용, 매출, ROI</div>
                    </div>

                    <div class="team-dataset" onclick="selectTeam('sales')">
                        <div class="team-name">👥 영업팀</div>
                        <div class="dataset-info">고객 LTV 예측 데이터</div>
                        <div class="dataset-fields">고객ID, 접촉이력, 계약금액, LTV</div>
                    </div>
                </div>
            </div>

            <!-- 중앙: 통합 분석 영역 -->
            <div class="analysis-main">
                <!-- 분석 헤더 -->
                <div class="analysis-header">
                    <div class="selected-team" id="selectedTeamTitle">분석할 팀을 선택해주세요</div>
                    <div class="analysis-request" id="analysisRequest">
                        좌측에서 팀 데이터셋을 선택하면 해당 팀의 요청사항이 표시됩니다.
                    </div>
                </div>

                <!-- 자동 데이터 검토 섹션 -->
                <div class="auto-review-section" id="autoReviewSection" style="display: none;">
                    <div class="review-header">
                        <div class="review-title">🔍 데이터셋 자동 검토 중...</div>
                        <div class="review-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="reviewProgressFill"></div>
                            </div>
                            <div class="progress-text" id="reviewProgressText">Step 3에서 전달받은 데이터를 분석 중...</div>
                        </div>
                    </div>
                    <div class="review-insights" id="reviewInsights">
                    </div>
                </div>

                <!-- 추천 모듈 섹션 -->
                <div class="recommended-modules" id="recommendedModules" style="display: none;">
                    <div class="modules-header">🎯 데이터 기반 추천 분석 모듈</div>
                    <div class="modules-grid" id="modulesGrid">
                    </div>
                    <div class="custom-request">
                        <div class="custom-request-text">원하는 분석이 없나요?</div>
                        <input type="text" class="custom-input" placeholder="예: 고객 생애가치 예측, 세그먼트별 캠페인 효과 분석..." id="customAnalysisInput">
                        <button class="custom-submit" onclick="submitCustomRequest()">맞춤 분석 요청</button>
                    </div>
                </div>

                <!-- 실행 섹션 -->
                <div class="execute-section" id="executeSection" style="display: none;">
                    <button class="execute-button" id="executeButton" onclick="startAnalysis()">
                        선택한 모듈로 분석 시작
                    </button>
                </div>

                <!-- 분석 선택 -->
                <div class="analysis-section" id="analysisSection" style="display: none;">
                    <div class="section-title">🤖 분석 유형 선택</div>
                    <div class="analysis-options">
                        <div class="analysis-option" onclick="selectAnalysis(this)">
                            <div class="option-title">🔍 세그먼트 분석</div>
                            <div class="option-desc">RFM 기반 고객 그룹별 특성 및 이탈 패턴 분석</div>
                        </div>
                        <div class="analysis-option" onclick="selectAnalysis(this)">
                            <div class="option-title">📈 예측 모델링</div>
                            <div class="option-desc">이탈 위험도 예측 및 개인화된 retention 전략</div>
                        </div>
                        <div class="analysis-option" onclick="selectAnalysis(this)">
                            <div class="option-title">🎯 캠페인 최적화</div>
                            <div class="option-desc">세그먼트별 맞춤 마케팅 캠페인 설계</div>
                        </div>
                        <div class="analysis-option" onclick="selectAnalysis(this)">
                            <div class="option-title">💡 통합 인사이트</div>
                            <div class="option-desc">전체 분석 결과 종합 및 액션플랜 도출</div>
                        </div>
                    </div>
                    <button class="execute-button-old" id="executeButtonOld" disabled onclick="startAnalysisOld()">
                        팀을 선택하고 분석 유형을 선택해주세요
                    </button>
                </div>

                <!-- 분석 진행 상태 -->
                <div class="analysis-progress" id="analysisProgress">
                    <div class="progress-header">
                        <div class="progress-icon">🤖</div>
                        <div class="progress-title">마케팅 에이전트 분석 진행 중</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-content" id="progressContent">Sense 단계: 데이터 패턴 인식 중...</div>
                </div>

                <!-- 분석 결과 -->
                <div class="results-section" id="resultsSection">
                    <div class="section-title">📋 분석 결과 (총 4건)</div>
                    <div class="results-grid">
                        <div class="result-item">
                            <div class="result-content">
                                <strong>핵심 발견:</strong> 모바일 앱 사용 빈도와 강한 상관관계 확인됨. 주요 이탈 시점은 첫 구매 후 3개월 이내가 67%를 차지하며, 이는 온보딩 프로세스 개선이 시급함을 시사합니다. 특히 앱 푸시 알림 수신률이 낮은 고객군(18%)에서 이탈률이 2.3배 높게 나타났습니다.
                            </div>
                            <div class="result-actions">
                                <div class="action-tag tag-report selected" onclick="toggleTag(this)" data-type="report">Step 6 리포트</div>
                                <div class="add-team-btn" onclick="showTeamDropdown(this)">
                                    + 협업 팀 추가
                                    <div class="team-dropdown">
                                        <div class="dropdown-item" onclick="addCollaboration(this, '개발팀', '앱 푸시 알림 시스템 개선')">개발팀</div>
                                        <div class="dropdown-item" onclick="addCollaboration(this, '상품팀', '온보딩 프로세스 개선')">상품팀</div>
                                        <div class="dropdown-item" onclick="addCollaboration(this, '재무팀', '예산 검토')">재무팀</div>
                                        <div class="dropdown-item" onclick="addCollaboration(this, '영업팀', '고객 접점 확대')">영업팀</div>
                                    </div>
                                </div>
                            </div>
                            <div class="collab-comment-section" id="commentSection1">
                                <div class="collab-comment-label">협업 요청 사항 (Step 4 팀에게 전달됩니다)</div>
                                <textarea class="collab-comment-textarea" placeholder="구체적인 협업 요청사항을 입력해주세요..."></textarea>
                            </div>
                        </div>

                        <div class="result-item">
                            <div class="result-content">
                                <strong>추가 발견:</strong> 계절성 구매 패턴이 이탈률에 미치는 영향이 예상보다 큼. 겨울철(12-2월) 이탈률이 37% 증가하며, 이는 상품 포트폴리오 확장 필요성을 시사합니다. 특히 겨울 관련 상품군 보강이 시급하며, 경쟁사 대비 겨울 상품 라인업이 43% 부족한 상황입니다.
                            </div>
                            <div class="result-actions">
                                <div class="action-tag tag-report selected" onclick="toggleTag(this)" data-type="report">Step 6 리포트</div>
                                <div class="add-team-btn" onclick="showTeamDropdown(this)">
                                    + 협업 팀 추가
                                    <div class="team-dropdown">
                                        <div class="dropdown-item" onclick="addCollaboration(this, '상품팀', '겨울 상품 라인업 확장')">상품팀</div>
                                        <div class="dropdown-item" onclick="addCollaboration(this, '재무팀', '상품 확장 예산')">재무팀</div>
                                        <div class="dropdown-item" onclick="addCollaboration(this, '영업팀', '계절별 영업 전략')">영업팀</div>
                                        <div class="dropdown-item" onclick="addCollaboration(this, '개발팀', '시스템 개선')">개발팀</div>
                                    </div>
                                </div>
                            </div>
                            <div class="collab-comment-section" id="commentSection2">
                                <div class="collab-comment-label">협업 요청 사항 (Step 4 팀에게 전달됩니다)</div>
                                <textarea class="collab-comment-textarea" placeholder="구체적인 협업 요청사항을 입력해주세요..."></textarea>
                            </div>
                        </div>

                        <div class="result-item">
                            <div class="result-content">
                                <strong>전략 제안:</strong> 개인화 Push 알림 시스템 도입으로 이탈률 35% 감소 예상. 구현 예산 약 3,000만원 추정되며, ROI는 6개월 내 회수 가능. A/B 테스트를 통한 점진적 적용을 권장하며, 1단계로 고위험군 1,200명부터 테스트 시작 제안. 예상 매출 증대 효과는 월 2,400만원 수준입니다.
                            </div>
                            <div class="result-actions">
                                <div class="action-tag tag-report selected" onclick="toggleTag(this)" data-type="report">Step 6 리포트</div>
                                <div class="add-team-btn" onclick="showTeamDropdown(this)">
                                    + 협업 팀 추가
                                    <div class="team-dropdown">
                                        <div class="dropdown-item" onclick="addCollaboration(this, '재무팀', 'ROI 검증 및 예산 승인')">재무팀</div>
                                        <div class="dropdown-item" onclick="addCollaboration(this, '개발팀', 'Push 시스템 구현')">개발팀</div>
                                        <div class="dropdown-item" onclick="addCollaboration(this, '상품팀', 'A/B 테스트 설계')">상품팀</div>
                                        <div class="dropdown-item" onclick="addCollaboration(this, '영업팀', '고위험군 고객 관리')">영업팀</div>
                                    </div>
                                </div>
                            </div>
                            <div class="collab-comment-section" id="commentSection3">
                                <div class="collab-comment-label">협업 요청 사항 (Step 4 팀에게 전달됩니다)</div>
                                <textarea class="collab-comment-textarea" placeholder="구체적인 협업 요청사항을 입력해주세요..."></textarea>
                            </div>
                        </div>

                        <div class="result-item">
                            <div class="result-content">
                                <strong>세그먼트 분석:</strong> 프리미엄 고객(상위 20%)의 LTV가 일반 고객 대비 4.2배 높음. 이들의 특성은 월 3회 이상 구매, 리뷰 작성률 85%, 추천 프로그램 참여율 92%입니다. 집중 관리를 통한 매출 증대 효과가 클 것으로 예상되며, 전용 CS팀 운영 시 고객 만족도 15% 추가 상승 가능합니다.
                            </div>
                            <div class="result-actions">
                                <div class="action-tag tag-report selected" onclick="toggleTag(this)" data-type="report">Step 6 리포트</div>
                                <div class="add-team-btn" onclick="showTeamDropdown(this)">
                                    + 협업 팀 추가
                                    <div class="team-dropdown">
                                        <div class="dropdown-item" onclick="addCollaboration(this, '영업팀', 'VIP 고객 전담 관리')">영업팀</div>
                                        <div class="dropdown-item" onclick="addCollaboration(this, '상품팀', '프리미엄 서비스 기획')">상품팀</div>
                                        <div class="dropdown-item" onclick="addCollaboration(this, '재무팀', 'VIP 프로그램 투자 검토')">재무팀</div>
                                        <div class="dropdown-item" onclick="addCollaboration(this, 'CS팀', '전용 CS팀 구성')">CS팀</div>
                                    </div>
                                </div>
                            </div>
                            <div class="collab-comment-section" id="commentSection4">
                                <div class="collab-comment-label">협업 요청 사항 (Step 4 팀에게 전달됩니다)</div>
                                <textarea class="collab-comment-textarea" placeholder="구체적인 협업 요청사항을 입력해주세요..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 빈 상태 -->
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">🤖</div>
                    <div>분석 형태를 선택하고 실행 버튼을 클릭해주세요</div>
                </div>
            </div>

            <!-- 우측: SPAR + 협업 도구 -->
            <div class="right-panel">
                <!-- SPAR 상태 -->
                <div class="spar-section" id="sparSection">
                    <div class="spar-title">🤖 에이전트 사고 과정</div>
                    <div class="spar-steps">
                        <div class="spar-step completed" id="senseStep">
                            <div class="spar-icon sense">S</div>
                            <div class="spar-content">
                                <div class="spar-label">Sense</div>
                                <div class="spar-desc">데이터 패턴 인식 완료</div>
                            </div>
                            <div class="sense-tooltip" id="senseTooltip">
                                좌측에서 분석할 팀을 선택하고 에이전트 분석을 시작해보세요!
                            </div>
                        </div>
                        
                        <div class="spar-step">
                            <div class="spar-icon plan">P</div>
                            <div class="spar-content">
                                <div class="spar-label">Plan</div>
                                <div class="spar-desc">분석 전략 수립 대기</div>
                            </div>
                        </div>
                        
                        <div class="spar-step">
                            <div class="spar-icon act">A</div>
                            <div class="spar-content">
                                <div class="spar-label">Act</div>
                                <div class="spar-desc">분석 실행 대기</div>
                            </div>
                        </div>
                        
                        <div class="spar-step">
                            <div class="spar-icon reflect">R</div>
                            <div class="spar-content">
                                <div class="spar-label">Reflect</div>
                                <div class="spar-desc">결과 검증 대기</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 협업 장바구니 -->
                <div class="collaboration-section">
                    <div class="collab-title">🛒 협업 요청 장바구니</div>
                    <div class="collaboration-cart">
                        <div class="cart-header">선택된 협업 요청</div>
                        <div class="cart-items" id="cartItems">
                            <div class="cart-empty">아직 선택된 협업 요청이 없습니다</div>
                        </div>
                        <button class="send-collaboration-btn" id="sendCollabBtn" disabled onclick="sendCollaborationRequests()">
                            협업 요청 전송
                        </button>
                        <div class="success-message" id="successMessage">
                            협업 요청이 Step 4 워크스페이스에 전송되었습니다!
                        </div>
                    </div>

                    <div class="collaboration-summary">
                        <div class="summary-item">
                            <span class="summary-label">Step 6 리포트 선택</span>
                            <span class="summary-count" id="reportCount">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">협업 요청 대기</span>
                            <span class="summary-count orange" id="collaborateCount">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 하단 컨트롤 -->
            <div class="bottom-controls">
                <button class="nav-button" type="button" onclick="window.location.href='index.html'">◁ Step 3: 협업 워크스페이스</button>
                <button class="nav-button" type="button" onclick="window.location.href='report_fixed.html'">Step 5: 통합 리포트 ▷</button>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let selectedModules = [];
        let currentTeam = null;
        let isAnalysisComplete = false;
        let collaborationCart = [];
        
        // 팀 데이터 정보
        const teamData = {
            marketing: {
                title: "📊 마케팅팀 에이전트 분석",
                request: "고객 세그먼트별 이탈률 분석 및 retention 전략 수립",
                insights: [
                    { icon: "📊", text: "고객 구매 데이터 12,847건 확인" },
                    { icon: "📅", text: "2023-2024년 24개월 기간 데이터" },
                    { icon: "🎯", text: "RFM 분석에 최적화된 구조 확인" },
                    { icon: "⚠️", text: "최근 3개월 이탈 고객 데이터 부족" }
                ],
                modules: [
                    { id: 'rfm', icon: '🎯', title: 'RFM 고객 세그먼트', desc: '구매 빈도/금액/최근성 기반 고객 분류 및 이탈 예측', confidence: 95, time: 3 },
                    { id: 'churn', icon: '⚠️', title: '이탈 위험 고객 탐지', desc: '구매 패턴 변화로 이탈 가능성 높은 고객 식별', confidence: 88, time: 4 },
                    { id: 'retention', icon: '🔄', title: '리텐션 전략 수립', desc: '세그먼트별 맞춤형 유지 전략 및 액션 플랜', confidence: 92, time: 5 }
                ]
            },
            finance: {
                title: "💰 재무팀 에이전트 분석",
                request: "마케팅 캠페인 ROI 최적화 및 예산 배분 전략",
                insights: [
                    { icon: "💸", text: "캠페인 비용 데이터 847건 확인" },
                    { icon: "📈", text: "ROI 추적이 가능한 채널 15개" },
                    { icon: "🎯", text: "성과 측정 KPI 체계 완비" },
                    { icon: "❓", text: "오가닉 트래픽 기여도 데이터 필요" }
                ],
                modules: [
                    { id: 'roi', icon: '💰', title: 'ROI 분석 및 최적화', desc: '채널별 투자 대비 수익률 분석 및 예산 재배분', confidence: 93, time: 4 },
                    { id: 'budget', icon: '📊', title: '예산 배분 전략', desc: '성과 기반 최적 예산 배분 시뮬레이션', confidence: 87, time: 6 },
                    { id: 'attribution', icon: '🔗', title: '어트리뷰션 모델링', desc: '다채널 기여도 분석 및 터치포인트 최적화', confidence: 82, time: 7 }
                ]
            },
            sales: {
                title: "👥 영업팀 에이전트 분석",
                request: "고객 LTV 예측 및 영업 우선순위 최적화",
                insights: [
                    { icon: "👥", text: "리드 및 고객 데이터 5,234건 확인" },
                    { icon: "💼", text: "영업 단계별 전환율 추적 가능" },
                    { icon: "📞", text: "접촉 이력 및 성과 데이터 완비" },
                    { icon: "❗", text: "고객 만족도 설문 데이터 보완 필요" }
                ],
                modules: [
                    { id: 'ltv', icon: '💎', title: 'LTV 예측 모델', desc: '고객별 생애가치 예측 및 우선순위 매트릭스', confidence: 91, time: 5 },
                    { id: 'pipeline', icon: '🔄', title: '세일즈 파이프라인 최적화', desc: '단계별 전환율 개선 포인트 및 액션 플랜', confidence: 89, time: 4 },
                    { id: 'scoring', icon: '🎯', title: '리드 스코어링', desc: '성약 가능성 기반 리드 우선순위 자동 채점', confidence: 86, time: 3 }
                ]
            }
        };

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            showSenseTooltip();
            document.getElementById('reportCount').textContent = '0';
            document.getElementById('collaborateCount').textContent = '0';
            // 초기 펄스 효과 추가
            addInitialPulseEffects();
        });

        // 초기 강한 펄스 효과 추가
        function addInitialPulseEffects() {
            const teamContext = document.getElementById('teamContext');
            const sparSection = document.getElementById('sparSection');
            
            // 팀 선택 영역에 강한 펄스 효과
            teamContext.classList.add('initial-pulse');
            
            // 에이전트 사고 과정 영역에 강한 펄스 효과
            sparSection.classList.add('initial-pulse');
            
            // 10초 후 펄스 효과 제거
            setTimeout(() => {
                teamContext.classList.remove('initial-pulse');
                sparSection.classList.remove('initial-pulse');
            }, 10000);
        }

        // Sense 말풍선 표시
        function showSenseTooltip() {
            setTimeout(() => {
                const tooltip = document.getElementById('senseTooltip');
                tooltip.classList.add('show');
                
                // 5초 후 자동 숨김
                setTimeout(() => {
                    tooltip.classList.remove('show');
                }, 5000);
            }, 1000);
        }

        // 팀 선택 함수
        function selectTeam(team) {
            currentTeam = team;
            
            // 팀 데이터셋 UI 업데이트
            document.querySelectorAll('.team-dataset').forEach(d => d.classList.remove('active'));
            event.target.closest('.team-dataset').classList.add('active');
            
            // 헤더 정보 업데이트
            const teamInfo = teamData[team];
            document.getElementById('selectedTeamTitle').textContent = teamInfo.title;
            document.getElementById('analysisRequest').textContent = `Step 4 요청사항: "${teamInfo.request}"`;
            
            // 기존 분석 상태 초기화
            selectedModules = [];
            isAnalysisComplete = false;
            
            // 협업 장바구니 초기화
            collaborationCart = [];
            updateCartUI();
            
            // 모든 코멘트 섹션 숨기기
            document.querySelectorAll('.collab-comment-section').forEach(section => {
                section.classList.remove('show');
            });
            
            // Sense 말풍선 숨기기
            document.getElementById('senseTooltip').classList.remove('show');
            
            // 빈 상태 숨기기
            document.getElementById('emptyState').style.display = 'none';
            
            // 자동 검토 재시작
            resetToAutoReview();
        }
        
        // 자동 검토로 리셋
        function resetToAutoReview() {
            if (!currentTeam) return;
            
            document.getElementById('recommendedModules').style.display = 'none';
            document.getElementById('executeSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('autoReviewSection').style.display = 'block';
            
            // 진행률 바 초기화
            const progressFill = document.getElementById('reviewProgressFill');
            const progressText = document.getElementById('reviewProgressText');
            progressFill.style.width = '0%';
            progressText.textContent = 'Step 4에서 전달받은 데이터를 분석 중...';
            
            // 인사이트 업데이트
            const insightsContainer = document.getElementById('reviewInsights');
            const teamInfo = teamData[currentTeam];
            
            insightsContainer.innerHTML = '';
            teamInfo.insights.forEach((insight, index) => {
                const item = document.createElement('div');
                item.className = 'insight-item';
                item.innerHTML = `
                    <span class="insight-icon">${insight.icon}</span>
                    <span>${insight.text}</span>
                `;
                insightsContainer.appendChild(item);
            });
            
            // 진행률 리셋 후 재시작
            setTimeout(() => {
                startAutoReview();
            }, 500);
        }
        
        // 자동 데이터 검토 시작
        function startAutoReview() {
            if (!currentTeam) return;
            
            const progressFill = document.getElementById('reviewProgressFill');
            const progressText = document.getElementById('reviewProgressText');
            const insights = document.querySelectorAll('.insight-item');
            
            // 진행률 애니메이션
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15 + 5;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(progressInterval);
                    
                    // 검토 완료 후 모듈 표시
                    setTimeout(() => {
                        showRecommendedModules();
                    }, 1000);
                }
                progressFill.style.width = progress + '%';
                
                // 진행 단계별 텍스트 변경
                if (progress < 30) {
                    progressText.textContent = 'Step 4에서 전달받은 데이터를 분석 중...';
                } else if (progress < 60) {
                    progressText.textContent = '데이터 구조 및 품질을 검증하고 있습니다...';
                } else if (progress < 90) {
                    progressText.textContent = '분석 가능한 모듈을 탐지하고 있습니다...';
                } else {
                    progressText.textContent = '✅ 데이터 검토 완료! 추천 모듈을 준비 중...';
                }
            }, 200);

            // 인사이트 순차 표시
            insights.forEach((insight, index) => {
                setTimeout(() => {
                    insight.classList.add('show');
                }, (index + 1) * 800);
            });
        }
        
        // 추천 모듈 표시
        function showRecommendedModules() {
            if (!currentTeam) return;
            
            document.getElementById('autoReviewSection').style.display = 'none';
            document.getElementById('recommendedModules').style.display = 'block';
            
            // 모듈 카드 동적 생성
            const modulesGrid = document.getElementById('modulesGrid');
            const teamInfo = teamData[currentTeam];
            
            modulesGrid.innerHTML = '';
            teamInfo.modules.forEach((module, index) => {
                const moduleCard = document.createElement('div');
                moduleCard.className = 'module-card';
                moduleCard.setAttribute('data-module', module.id);
                moduleCard.onclick = () => selectModule(module.id);
                moduleCard.innerHTML = `
                    <div class="module-icon">${module.icon}</div>
                    <div class="module-title">${module.title}</div>
                    <div class="module-desc">${module.desc}</div>
                    <div class="module-meta">
                        <span class="confidence-badge">적합도 ${module.confidence}%</span>
                        <span>예상 시간: ${module.time}분</span>
                    </div>
                `;
                modulesGrid.appendChild(moduleCard);
                
                // 순차 표시
                setTimeout(() => {
                    moduleCard.classList.add('show');
                }, index * 300);
            });
        }
        
        // 모듈 선택
        function selectModule(moduleId) {
            // 모든 모듈 선택 해제
            document.querySelectorAll('.module-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 선택된 모듈 표시
            const selectedCard = document.querySelector(`[data-module="${moduleId}"]`);
            selectedCard.classList.add('selected');
            selectedModules = [moduleId];
            
            // 실행 버튼 표시
            document.getElementById('executeSection').style.display = 'block';
            
            // 버튼 텍스트 업데이트
            const teamInfo = teamData[currentTeam];
            const module = teamInfo.modules.find(m => m.id === moduleId);
            document.getElementById('executeButton').textContent = `${module.title} 분석 시작`;
        }
        
        // 맞춤 분석 요청
        function submitCustomRequest() {
            const input = document.getElementById('customAnalysisInput');
            const customText = input.value.trim();
            
            if (customText) {
                // 맞춤 모듈 카드 추가
                const modulesGrid = document.getElementById('modulesGrid');
                const customCard = document.createElement('div');
                customCard.className = 'module-card selected show';
                customCard.setAttribute('data-module', 'custom');
                customCard.onclick = () => selectModule('custom');
                customCard.innerHTML = `
                    <div class="module-icon">🔧</div>
                    <div class="module-title">맞춤 분석</div>
                    <div class="module-desc">${customText}</div>
                    <div class="module-meta">
                        <span class="confidence-badge">검토 중</span>
                        <span>예상 시간: 계산 중</span>
                    </div>
                `;
                modulesGrid.appendChild(customCard);
                
                // 선택 상태로 설정
                selectedModules = ['custom'];
                document.getElementById('executeSection').style.display = 'block';
                document.getElementById('executeButton').textContent = '맞춤 분석 시작';
                
                input.value = '';
            }
        }

        // 분석 옵션 선택 함수
        function selectAnalysis(element) {
            document.querySelectorAll('.analysis-option').forEach(o => o.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('executeButton').disabled = false;
        }

        // 분석 시작 함수
        function startAnalysis() {
            // UI 전환 - 추천 모듈 섹션과 분석 선택 섹션 숨기기
            document.getElementById('recommendedModules').style.display = 'none';
            document.getElementById('executeSection').style.display = 'none';
            document.getElementById('analysisSection').classList.add('hidden');
            document.getElementById('analysisProgress').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            
            // SPAR 프로세스 시뮬레이션
            simulateSparProcess();
        }

        // SPAR 프로세스 시뮬레이션
        function simulateSparProcess() {
            const sparSteps = document.querySelectorAll('.spar-step');
            const progressFill = document.getElementById('progressFill');
            const progressContent = document.getElementById('progressContent');
            
            const steps = [
                { name: 'Plan', desc: 'RFM 분석 전략을 수립하고 있습니다...', progress: 35, index: 1 },
                { name: 'Act', desc: '세그먼트 분류 및 예측 모델을 실행하고 있습니다...', progress: 70, index: 2 },
                { name: 'Reflect', desc: '결과를 검증하고 인사이트를 도출하고 있습니다...', progress: 100, index: 3 }
            ];

            let currentStep = 0;

            function updateStep() {
                if (currentStep < steps.length) {
                    const step = steps[currentStep];
                    
                    // 이전 단계 완료 처리
                    if (currentStep > 0) {
                        sparSteps[steps[currentStep-1].index].classList.remove('progress');
                        sparSteps[steps[currentStep-1].index].classList.add('completed');
                        sparSteps[steps[currentStep-1].index].querySelector('.spar-desc').textContent = '완료';
                    }
                    
                    // 현재 단계를 진행 중 상태로 활성화
                    sparSteps[step.index].classList.add('progress');
                    sparSteps[step.index].querySelector('.spar-desc').textContent = step.desc.replace(step.name + ' 단계: ', '');
                    
                    // 진행률 업데이트
                    progressFill.style.width = step.progress + '%';
                    progressContent.textContent = `${step.name} 단계: ${step.desc}`;
                    
                    currentStep++;
                    setTimeout(updateStep, 2500);
                } else {
                    // 분석 완료
                    completeAnalysis();
                }
            }

            // Plan 단계부터 시작
            sparSteps[1].classList.add('progress');
            sparSteps[1].querySelector('.spar-desc').textContent = 'RFM 분석 전략 수립 중...';
            updateStep();
        }

        // 분석 완료
        function completeAnalysis() {
            // UI 전환
            document.getElementById('analysisProgress').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            // 모든 SPAR 단계 완료
            document.querySelectorAll('.spar-step').forEach(step => {
                step.classList.remove('active', 'progress');
                step.classList.add('completed');
                step.querySelector('.spar-desc').textContent = '완료';
            });
            
            // 협업 요약 업데이트
            updateCollaborationSummary();
            
            // Step 6 버튼 활성화
            document.getElementById('nextButton').disabled = false;
            isAnalysisComplete = true;
        }

        // 태그 토글 함수 (Step 6 리포트)
        function toggleTag(element) {
            element.classList.toggle('selected');
            updateCollaborationSummary();
        }

        // 팀 드롭다운 표시
        function showTeamDropdown(button) {
            // 다른 드롭다운 모두 닫기
            document.querySelectorAll('.team-dropdown').forEach(dropdown => {
                if (dropdown !== button.querySelector('.team-dropdown')) {
                    dropdown.classList.remove('show');
                }
            });
            
            // 현재 드롭다운 토글
            const dropdown = button.querySelector('.team-dropdown');
            dropdown.classList.toggle('show');
            
            // 외부 클릭 시 닫기
            setTimeout(() => {
                document.addEventListener('click', function closeDropdown(e) {
                    if (!button.contains(e.target)) {
                        dropdown.classList.remove('show');
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            }, 100);
        }

        // 협업 추가 함수
        function addCollaboration(element, team, purpose) {
            // 결과 항목 식별
            const resultItem = element.closest('.result-item');
            const resultContent = resultItem.querySelector('.result-content strong').textContent;
            
            // 중복 체크
            const existingItem = collaborationCart.find(item => 
                item.team === team && item.resultType === resultContent
            );
            
            if (!existingItem) {
                // 장바구니에 추가
                collaborationCart.push({
                    team: team,
                    purpose: purpose,
                    resultType: resultContent,
                    resultItem: resultItem
                });
                
                // 시각적 피드백
                const addBtn = resultItem.querySelector('.add-team-btn');
                const originalText = addBtn.innerHTML;
                addBtn.innerHTML = `✓ ${team} 추가됨`;
                addBtn.style.background = '#28a745';
                addBtn.style.color = 'white';
                addBtn.style.borderColor = '#28a745';
                
                // 코멘트 섹션 표시
                const commentSection = resultItem.querySelector('.collab-comment-section');
                if (commentSection) {
                    commentSection.classList.add('show');
                }
                
                setTimeout(() => {
                    addBtn.innerHTML = originalText;
                    addBtn.style.background = '';
                    addBtn.style.color = '';
                    addBtn.style.borderColor = '';
                }, 1500);
                
                // 장바구니 UI 업데이트
                updateCartUI();
            }
            
            // 드롭다운 닫기
            element.closest('.team-dropdown').classList.remove('show');
        }

        // 장바구니 UI 업데이트
        function updateCartUI() {
            const cartItems = document.getElementById('cartItems');
            const sendBtn = document.getElementById('sendCollabBtn');
            
            if (collaborationCart.length === 0) {
                cartItems.innerHTML = '<div class="cart-empty">아직 선택된 협업 요청이 없습니다</div>';
                sendBtn.disabled = true;
            } else {
                cartItems.innerHTML = collaborationCart.map((item, index) => `
                    <div class="cart-item">
                        <div class="cart-item-text">
                            <strong>${item.team}</strong>: ${item.purpose}
                        </div>
                        <div class="cart-remove" onclick="removeFromCart(${index})">×</div>
                    </div>
                `).join('');
                sendBtn.disabled = false;
            }
            
            updateCollaborationSummary();
        }

        // 장바구니에서 제거
        function removeFromCart(index) {
            collaborationCart.splice(index, 1);
            updateCartUI();
        }

        // 협업 요청 전송
        function sendCollaborationRequests() {
            if (collaborationCart.length === 0) return;
            
            // 성공 메시지 표시
            const successMsg = document.getElementById('successMessage');
            successMsg.style.display = 'block';
            
            // 버튼 상태 변경
            const sendBtn = document.getElementById('sendCollabBtn');
            sendBtn.textContent = '전송 완료 ✓';
            sendBtn.style.background = '#28a745';
            sendBtn.disabled = true;
            
            // 장바구니 비우기
            collaborationCart = [];
            
            setTimeout(() => {
                successMsg.style.display = 'none';
                sendBtn.textContent = '협업 요청 전송';
                sendBtn.style.background = '';
                updateCartUI();
            }, 3000);
        }

        // 협업 요약 업데이트
        function updateCollaborationSummary() {
            // 결과가 나온 후에만 리포트 카운트 계산
            let reportCount = 0;
            if (isAnalysisComplete) {
                const reportTags = document.querySelectorAll('.tag-report.selected');
                reportCount = reportTags.length;
            }
            const collaborateCount = collaborationCart.length;
            
            document.getElementById('reportCount').textContent = reportCount;
            document.getElementById('collaborateCount').textContent = collaborateCount;
        }

        // 네비게이션 함수들
        function goToStep4() {
            if (confirm('Step 3 협업 워크스페이스로 이동하시겠습니까?\n현재 분석 진행상황은 저장됩니다.')) {
                alert('Step 3 협업 워크스페이스로 이동합니다.');
            }
        }

        function goToStep6() {
            if (isAnalysisComplete) {
                alert('Step 5 통합 리포트로 이동합니다.');
            }
        }
    </script>
</body>
</html>